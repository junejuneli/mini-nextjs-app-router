# Next.js ç¼“å­˜ç­–ç•¥å®Œæ•´æŒ‡å—

> æ·±å…¥è§£æ Next.js 15 çš„å››å±‚ç¼“å­˜æœºåˆ¶åŠå…¶å·¥ä½œåŸç†ï¼Œå¯¹æ¯” Mini Next.js å®ç°

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [Next.js 15 é‡å¤§å˜åŒ–](#nextjs-15-é‡å¤§å˜åŒ–)
- [å››å±‚ç¼“å­˜æœºåˆ¶](#å››å±‚ç¼“å­˜æœºåˆ¶)
  - [1. Request Memoization (è¯·æ±‚è®°å¿†åŒ–)](#1-request-memoization-è¯·æ±‚è®°å¿†åŒ–)
  - [2. Data Cache (æ•°æ®ç¼“å­˜)](#2-data-cache-æ•°æ®ç¼“å­˜)
  - [3. Full Route Cache (å®Œæ•´è·¯ç”±ç¼“å­˜)](#3-full-route-cache-å®Œæ•´è·¯ç”±ç¼“å­˜)
  - [4. Router Cache (è·¯ç”±å™¨ç¼“å­˜)](#4-router-cache-è·¯ç”±å™¨ç¼“å­˜)
- [ç¼“å­˜äº¤äº’å…³ç³»](#ç¼“å­˜äº¤äº’å…³ç³»)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [Mini Next.js å®ç°å¯¹æ¯”](#mini-nextjs-å®ç°å¯¹æ¯”)

---

## æ¦‚è¿°

Next.js å®ç°äº†ä¸€ä¸ªå¤æ‚çš„å¤šå±‚ç¼“å­˜ç³»ç»Ÿï¼Œæ—¨åœ¨ä¼˜åŒ–æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚è¿™äº›ç¼“å­˜å±‚çº§åœ¨ä¸åŒçš„é˜¶æ®µå’Œä½ç½®å·¥ä½œï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Next.js ç¼“å­˜æ¶æ„                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Client Side (æµè§ˆå™¨)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  4. Router Cache (å®¢æˆ·ç«¯è·¯ç”±ç¼“å­˜)                   â”‚   â”‚
â”‚  â”‚     - ç¼“å­˜ RSC Payload                               â”‚   â”‚
â”‚  â”‚     - å®¢æˆ·ç«¯å¯¼èˆª                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†•                                    â”‚
â”‚  Server Side (æœåŠ¡å™¨)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. Full Route Cache (å®Œæ•´è·¯ç”±ç¼“å­˜)                 â”‚   â”‚
â”‚  â”‚     - ç¼“å­˜æ¸²æŸ“ç»“æœ (RSC Payload + HTML)             â”‚   â”‚
â”‚  â”‚     - é™æ€è·¯ç”±é¢„æ¸²æŸ“                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†•                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. Data Cache (æ•°æ®ç¼“å­˜)                           â”‚   â”‚
â”‚  â”‚     - æŒä¹…åŒ– fetch è¯·æ±‚ç»“æœ                          â”‚   â”‚
â”‚  â”‚     - æ”¯æŒ ISR é‡æ–°éªŒè¯                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†•                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. Request Memoization (è¯·æ±‚è®°å¿†åŒ–)                â”‚   â”‚
â”‚  â”‚     - å•æ¬¡è¯·æ±‚å†…å»é‡                                  â”‚   â”‚
â”‚  â”‚     - React æ¸²æŸ“æœŸé—´è‡ªåŠ¨å»é‡                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Next.js 15 é‡å¤§å˜åŒ–

Next.js 15 å¯¹ç¼“å­˜ç­–ç•¥è¿›è¡Œäº†é‡å¤§è°ƒæ•´ï¼Œä»**é»˜è®¤ç¼“å­˜ä¸€åˆ‡**è½¬å˜ä¸º**é»˜è®¤ä¸ç¼“å­˜**ï¼ˆOpt-in ç­–ç•¥ï¼‰ï¼š

### ğŸ”´ å˜åŒ–å¯¹æ¯”

| ç¼“å­˜ç±»å‹ | Next.js 14 åŠä»¥ä¸‹ | Next.js 15 |
|---------|------------------|------------|
| **fetch() è¯·æ±‚** | é»˜è®¤ `cache: 'force-cache'` | é»˜è®¤ `cache: 'no-store'` |
| **GET Route Handlers** | é»˜è®¤ç¼“å­˜ | é»˜è®¤ä¸ç¼“å­˜ |
| **Client Router Cache** | åŠ¨æ€è·¯ç”± 30sï¼Œé¢„å– 5min | åŠ¨æ€è·¯ç”± 0s (ä¸ç¼“å­˜) |
| **é™æ€è·¯ç”±æ„å»º** | æ¸²æŸ“ä¸¤æ¬¡ | æ¸²æŸ“ä¸€æ¬¡ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰ |

### ä¸ºä»€ä¹ˆæ”¹å˜ï¼Ÿ

1. **é¿å…è¿‡åº¦ç¼“å­˜**ï¼šå¤šå±‚ç¼“å­˜è®¾è®¡å®¹æ˜“å¯¼è‡´æ•°æ®é™ˆæ—§
2. **æ›´å¥½çš„å¼€å‘ä½“éªŒ**ï¼šé»˜è®¤è¡Œä¸ºæ›´ç¬¦åˆç›´è§‰
3. **ç²¾ç»†æ§åˆ¶**ï¼šå¼€å‘è€…æ˜¾å¼é€‰æ‹©éœ€è¦ç¼“å­˜çš„å†…å®¹
4. **å‡å°‘å›°æƒ‘**ï¼šç¼“å­˜é—®é¢˜æ›´å®¹æ˜“å®šä½

---

## å››å±‚ç¼“å­˜æœºåˆ¶

### 1. Request Memoization (è¯·æ±‚è®°å¿†åŒ–)

#### ğŸ“Œ å®šä¹‰

React æ‰©å±•çš„ `fetch` APIï¼Œåœ¨**å•æ¬¡æ¸²æŸ“å‘¨æœŸå†…**è‡ªåŠ¨å»é‡ç›¸åŒçš„è¯·æ±‚ã€‚

#### ğŸ¯ ä½œç”¨èŒƒå›´

- **æ—¶é—´èŒƒå›´**ï¼šä»…é™å•æ¬¡æœåŠ¡å™¨è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸ
- **ç©ºé—´èŒƒå›´**ï¼šReact ç»„ä»¶æ ‘æ¸²æŸ“æœŸé—´
- **è¯·æ±‚ç±»å‹**ï¼šä»… GET è¯·æ±‚

#### ğŸ’¡ å·¥ä½œåŸç†

```jsx
// ç¤ºä¾‹ï¼šå¤šä¸ªç»„ä»¶è¯·æ±‚ç›¸åŒæ•°æ®
async function UserProfile() {
  const user = await fetch('https://api.example.com/user/1') // å®é™…è¯·æ±‚
  return <div>{user.name}</div>
}

async function UserStats() {
  const user = await fetch('https://api.example.com/user/1') // è‡ªåŠ¨å»é‡ï¼Œä¸ä¼šå‘èµ·æ–°è¯·æ±‚
  return <div>{user.posts} posts</div>
}

export default function Page() {
  return (
    <div>
      <UserProfile />
      <UserStats />
    </div>
  )
}
```

#### âš™ï¸ ç‰¹æ€§

- âœ… è‡ªåŠ¨å·¥ä½œï¼Œæ— éœ€é…ç½®
- âœ… è·¨è¶Š `generateMetadata`ã€`generateStaticParams`ã€Layoutsã€Pagesã€Server Components
- âœ… å‡å°‘é‡å¤è¯·æ±‚ï¼Œæå‡æ€§èƒ½
- âŒ **ä¸è·¨è¯·æ±‚**ï¼šæ¯æ¬¡æ–°çš„ç”¨æˆ·è¯·æ±‚éƒ½ä¼šé‡æ–°æ‰§è¡Œ
- âŒ **ä»…é™ fetch**ï¼šORM/æ•°æ®åº“æŸ¥è¯¢éœ€è¦ä½¿ç”¨ `React.cache()`

#### ğŸ”§ é fetch åœºæ™¯

```jsx
import { cache } from 'react'

// ä½¿ç”¨ React cache åŒ…è£…æ•°æ®åº“æŸ¥è¯¢
export const getUser = cache(async (id) => {
  const user = await db.user.findUnique({ where: { id } })
  return user
})

// åœ¨å¤šä¸ªç»„ä»¶ä¸­è°ƒç”¨ï¼Œè‡ªåŠ¨å»é‡
async function UserProfile() {
  const user = await getUser(1) // å®é™…æŸ¥è¯¢
  return <div>{user.name}</div>
}

async function UserStats() {
  const user = await getUser(1) // å»é‡ï¼Œè¿”å›ç¼“å­˜ç»“æœ
  return <div>{user.posts}</div>
}
```

---

### 2. Data Cache (æ•°æ®ç¼“å­˜)

#### ğŸ“Œ å®šä¹‰

æŒä¹…åŒ–çš„æœåŠ¡å™¨ç«¯æ•°æ®ç¼“å­˜ï¼Œè·¨è¯·æ±‚å’Œéƒ¨ç½²ä¿å­˜ `fetch` è¯·æ±‚ç»“æœã€‚

#### ğŸ¯ ä½œç”¨èŒƒå›´

- **æŒä¹…æ€§**ï¼šè·¨è¯·æ±‚ã€è·¨éƒ¨ç½²ï¼ˆé™¤éä¸»åŠ¨é‡æ–°éªŒè¯ï¼‰
- **ä½ç½®**ï¼šæœåŠ¡å™¨ç«¯æ–‡ä»¶ç³»ç»Ÿæˆ–å†…å­˜
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šé•¿æœŸå­˜å‚¨ï¼Œç›´åˆ°é‡æ–°éªŒè¯æˆ–æ¸…é™¤

#### ğŸ’¡ Next.js 15 é…ç½®

```jsx
// âŒ Next.js 15 é»˜è®¤ä¸ç¼“å­˜
fetch('https://api.example.com/posts')

// âœ… æ˜¾å¼å¯ç”¨ç¼“å­˜
fetch('https://api.example.com/posts', {
  cache: 'force-cache'
})

// âœ… ç¦ç”¨ç¼“å­˜ï¼ˆæ˜¾å¼å£°æ˜ï¼‰
fetch('https://api.example.com/posts', {
  cache: 'no-store'
})
```

#### ğŸ”„ é‡æ–°éªŒè¯ç­–ç•¥

##### 1ï¸âƒ£ æ—¶é—´åŸºç¡€é‡æ–°éªŒè¯ (Time-based Revalidation / ISR)

```jsx
// æ¯å°æ—¶é‡æ–°éªŒè¯ä¸€æ¬¡
fetch('https://api.example.com/posts', {
  next: { revalidate: 3600 } // ç§’æ•°
})
```

**å·¥ä½œæµç¨‹**ï¼š

```
ç¬¬ä¸€æ¬¡è¯·æ±‚ (t=0)
  â†’ æœªå‘½ä¸­ç¼“å­˜ â†’ è·å–æ•°æ® â†’ ç¼“å­˜ç»“æœ â†’ è¿”å›æ•°æ®

åç»­è¯·æ±‚ (0 < t < 3600s)
  â†’ å‘½ä¸­ç¼“å­˜ â†’ ç›´æ¥è¿”å›ç¼“å­˜æ•°æ® (å¿«é€Ÿå“åº”)

è¯·æ±‚ (t > 3600s) - è§¦å‘é‡æ–°éªŒè¯
  â†’ è¿”å›æ—§ç¼“å­˜ï¼ˆstale-while-revalidateï¼‰
  â†’ åå°è·å–æ–°æ•°æ® â†’ æ›´æ–°ç¼“å­˜
  â†’ ä¸‹ä¸€ä¸ªè¯·æ±‚è¿”å›æ–°æ•°æ®
```

##### 2ï¸âƒ£ æŒ‰éœ€é‡æ–°éªŒè¯ (On-demand Revalidation)

```jsx
// app/actions.js (Server Action)
'use server'
import { revalidatePath, revalidateTag } from 'next/cache'

export async function updatePost() {
  // æ–¹å¼1: æŒ‰è·¯å¾„é‡æ–°éªŒè¯
  revalidatePath('/blog/[slug]', 'page')

  // æ–¹å¼2: æŒ‰æ ‡ç­¾é‡æ–°éªŒè¯
  revalidateTag('posts')
}

// åœ¨ fetch ä¸­ä½¿ç”¨æ ‡ç­¾
fetch('https://api.example.com/posts', {
  next: {
    tags: ['posts'],
    revalidate: 3600
  }
})
```

#### âš ï¸ æ³¨æ„äº‹é¡¹

- å†²çªé€‰é¡¹ä¼šè¢«å¿½ç•¥ï¼š`{ revalidate: 3600, cache: 'no-store' }`
- å¤šä¸ª fetch ä¸åŒ revalidate æ—¶é—´ï¼šä½¿ç”¨**æœ€å°æ—¶é—´**è§¦å‘ ISR
- ISR ä»…æ”¯æŒ Node.js è¿è¡Œæ—¶ï¼ˆé»˜è®¤ï¼‰ï¼Œä¸æ”¯æŒ Static Export

---

### 3. Full Route Cache (å®Œæ•´è·¯ç”±ç¼“å­˜)

#### ğŸ“Œ å®šä¹‰

åœ¨æœåŠ¡å™¨ç«¯ç¼“å­˜**è·¯ç”±çš„å®Œæ•´æ¸²æŸ“ç»“æœ**ï¼ŒåŒ…æ‹¬ React Server Component Payload å’Œ HTMLã€‚

#### ğŸ¯ ä½œç”¨èŒƒå›´

- **é™æ€è·¯ç”±**ï¼šæ„å»ºæ—¶æˆ–é‡æ–°éªŒè¯åç¼“å­˜
- **åŠ¨æ€è·¯ç”±**ï¼šä¸ç¼“å­˜ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶æ¸²æŸ“
- **ä½ç½®**ï¼šæœåŠ¡å™¨ç«¯ï¼ˆ.next ç›®å½•ï¼‰

#### ğŸ’¡ å·¥ä½œåŸç†

```
æ„å»ºæ—¶ (npm run build)
  â†“
  é™æ€è·¯ç”±æ£€æµ‹
  â†“
  ç”Ÿæˆ RSC Payload + HTML
  â†“
  å­˜å‚¨åˆ° Full Route Cache
  â†“
  ç”Ÿäº§ç¯å¢ƒç›´æ¥è¿”å›ç¼“å­˜ç»“æœ
```

#### ğŸ” é™æ€ vs åŠ¨æ€è·¯ç”±

| è·¯ç”±ç±»å‹ | æ˜¯å¦ç¼“å­˜ | ä½•æ—¶æ¸²æŸ“ |
|---------|---------|---------|
| é™æ€è·¯ç”± | âœ… ç¼“å­˜ | æ„å»ºæ—¶ / é‡æ–°éªŒè¯æ—¶ |
| åŠ¨æ€è·¯ç”± | âŒ ä¸ç¼“å­˜ | æ¯æ¬¡è¯·æ±‚æ—¶ |

**é™æ€è·¯ç”±æ¡ä»¶**ï¼š

```jsx
// âœ… é™æ€è·¯ç”± - ä¼šè¢«ç¼“å­˜
export default async function Page() {
  const data = await fetch('https://api.example.com/posts', {
    next: { revalidate: 3600 }
  })
  return <div>{data}</div>
}

// âŒ åŠ¨æ€è·¯ç”± - ä¸ä¼šè¢«ç¼“å­˜
export const dynamic = 'force-dynamic' // å¼ºåˆ¶åŠ¨æ€æ¸²æŸ“

export default async function Page() {
  const data = await fetch('https://api.example.com/posts', {
    cache: 'no-store'
  })
  return <div>{data}</div>
}
```

#### ğŸ”„ ç¼“å­˜å¤±æ•ˆ

Full Route Cache ä¼šåœ¨ä»¥ä¸‹æƒ…å†µå¤±æ•ˆï¼š

1. **æ•°æ®é‡æ–°éªŒè¯**ï¼šData Cache é‡æ–°éªŒè¯æ—¶ï¼ŒFull Route Cache ä¹Ÿä¼šå¤±æ•ˆ
2. **æ–°éƒ¨ç½²**ï¼šéƒ¨ç½²æ–°ç‰ˆæœ¬ä¼šæ¸…é™¤ Full Route Cacheï¼ˆä¸ Data Cache ä¸åŒï¼‰
3. **æŒ‰éœ€é‡æ–°éªŒè¯**ï¼šè°ƒç”¨ `revalidatePath` æˆ– `revalidateTag`

#### âš¡ Next.js 15 ä¼˜åŒ–

```
Next.js 14 åŠä»¥ä¸‹ï¼š
  é™æ€é¡µé¢æ¸²æŸ“ä¸¤æ¬¡ï¼ˆç¬¬ä¸€æ¬¡æ„å»º + ç¬¬äºŒæ¬¡ä¼˜åŒ–ï¼‰

Next.js 15ï¼š
  é™æ€é¡µé¢åªæ¸²æŸ“ä¸€æ¬¡ï¼Œé‡ç”¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ç»“æœ
  â†’ æ˜¾è‘—å‡å°‘æ„å»ºæ—¶é—´
```

---

### 4. Router Cache (è·¯ç”±å™¨ç¼“å­˜)

#### ğŸ“Œ å®šä¹‰

å®¢æˆ·ç«¯ç¼“å­˜ï¼Œå­˜å‚¨ç”¨æˆ·å·²è®¿é—®è·¯ç”±çš„ **RSC Payload**ï¼Œå®ç°å¿«é€Ÿå¯¼èˆªã€‚

#### ğŸ¯ ä½œç”¨èŒƒå›´

- **ä½ç½®**ï¼šæµè§ˆå™¨å†…å­˜
- **æŒç»­æ—¶é—´**ï¼šç”¨æˆ·ä¼šè¯æœŸé—´
- **ç¼“å­˜å†…å®¹**ï¼šRSC Payloadï¼ˆä¸åŒ…å« HTMLï¼‰

#### ğŸ’¡ å·¥ä½œåŸç†

```
ç”¨æˆ·è®¿é—® /about
  â†“
  è·å– RSC Payload
  â†“
  å­˜å‚¨åˆ° Router Cache
  â†“
  ç”¨æˆ·å¯¼èˆªåˆ° /contact
  â†“
  ç”¨æˆ·ç‚¹å‡»è¿”å› /about
  â†“
  ä» Router Cache æ¢å¤ï¼ˆå³æ—¶åŠ è½½ï¼Œæ— ç½‘ç»œè¯·æ±‚ï¼‰
```

#### â±ï¸ Next.js 15 staleTime é…ç½®

```javascript
// next.config.js
module.exports = {
  experimental: {
    staleTimes: {
      dynamic: 0,      // åŠ¨æ€è·¯ç”±ï¼š0 ç§’ï¼ˆä¸ç¼“å­˜ï¼‰
      static: 300,     // é™æ€è·¯ç”±ï¼š300 ç§’ï¼ˆ5 åˆ†é’Ÿï¼‰
    },
  },
}
```

| é…ç½® | Next.js 14 | Next.js 15 |
|-----|-----------|-----------|
| `dynamic` (åŠ¨æ€è·¯ç”±) | 30 ç§’ | **0 ç§’** |
| `static` (é™æ€è·¯ç”±) | 5 åˆ†é’Ÿ | 5 åˆ†é’Ÿ |
| `prefetch: true` | 5 åˆ†é’Ÿ | 5 åˆ†é’Ÿ |

#### ğŸ”„ é¢„å– (Prefetching)

```jsx
import Link from 'next/link'

// é»˜è®¤è‡ªåŠ¨é¢„å–ï¼ˆè§†å£å†…çš„ Linkï¼‰
<Link href="/about">About</Link>

// ç¦ç”¨é¢„å–
<Link href="/about" prefetch={false}>About</Link>

// æ˜¾å¼é¢„å–
<Link href="/about" prefetch={true}>About</Link>

// ç¼–ç¨‹å¼é¢„å–
import { useRouter } from 'next/navigation'

function Component() {
  const router = useRouter()

  useEffect(() => {
    router.prefetch('/dashboard')
  }, [])
}
```

#### ğŸ¯ ç¼“å­˜è¡Œä¸º

| åœºæ™¯ | è¡Œä¸º |
|-----|-----|
| **å‰è¿›/åé€€å¯¼èˆª** | ä»ç¼“å­˜æ¢å¤ï¼ˆä¿ç•™æ»šåŠ¨ä½ç½®ï¼‰ |
| **æ™®é€šå¯¼èˆª (Next.js 15)** | åŠ¨æ€è·¯ç”±ä¸ç¼“å­˜ï¼Œå§‹ç»ˆè·å–æœ€æ–°æ•°æ® |
| **å…±äº« Layout** | ä¸é‡æ–°è·å–ï¼Œæ”¯æŒéƒ¨åˆ†æ¸²æŸ“ |
| **loading.js** | ç¼“å­˜ 5 åˆ†é’Ÿï¼ˆæˆ– `staleTimes.static` é…ç½®ï¼‰ |

#### ğŸ”§ æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜

```jsx
import { useRouter } from 'next/navigation'

function Component() {
  const router = useRouter()

  // åˆ·æ–°å½“å‰è·¯ç”±
  router.refresh()
}
```

---

## ç¼“å­˜äº¤äº’å…³ç³»

### ğŸ“Š ç¼“å­˜ä¼˜å…ˆçº§æµç¨‹

```
ç”¨æˆ·è¯·æ±‚ â†’ Router Cache
              â†“ (æœªå‘½ä¸­)
           Full Route Cache
              â†“ (æœªå‘½ä¸­)
           Data Cache
              â†“ (æœªå‘½ä¸­)
           Request Memoization
              â†“ (æœªå‘½ä¸­)
           å®é™…æ•°æ®æº (API/æ•°æ®åº“)
```

### ğŸ”„ ç¼“å­˜å¤±æ•ˆé“¾

```
revalidatePath('/blog') æˆ– revalidateTag('posts')
  â†“
  1. Data Cache å¤±æ•ˆï¼ˆé‡æ–°è·å–æ•°æ®ï¼‰
  â†“
  2. Full Route Cache å¤±æ•ˆï¼ˆé‡æ–°æ¸²æŸ“è·¯ç”±ï¼‰
  â†“
  3. Router Cache å¤±æ•ˆï¼ˆå®¢æˆ·ç«¯æ¸…é™¤ï¼‰
```

### ğŸ“ˆ ç¼“å­˜åœºæ™¯ç¤ºä¾‹

#### åœºæ™¯ 1: é™æ€é¡µé¢é¦–æ¬¡è®¿é—®

```
1. ç”¨æˆ·è®¿é—® /blog
2. Full Route Cache å‘½ä¸­ â†’ è¿”å›é¢„æ¸²æŸ“ HTML
3. å®¢æˆ·ç«¯ Hydration
4. å­˜å‚¨åˆ° Router Cache

æ€»å“åº”æ—¶é—´ï¼š< 50ms (æå¿«)
```

#### åœºæ™¯ 2: åŠ¨æ€é¡µé¢è®¿é—®

```
1. ç”¨æˆ·è®¿é—® /dashboard
2. Full Route Cache æœªå‘½ä¸­ï¼ˆåŠ¨æ€è·¯ç”±ï¼‰
3. æ£€æŸ¥ Data Cache
4. Request Memoization å»é‡
5. æ¸²æŸ“ RSC â†’ è¿”å› HTML
6. å­˜å‚¨åˆ° Router Cache (Next.js 15: ä¸å­˜å‚¨)

æ€»å“åº”æ—¶é—´ï¼š200-500ms (å–å†³äºæ•°æ®è·å–)
```

#### åœºæ™¯ 3: ISR é‡æ–°éªŒè¯

```
1. ç”¨æˆ·è®¿é—® /blog (revalidate: 60)
2. æ£€æµ‹é¡µé¢å·²è¿‡æœŸ (age > 60s)
3. ç«‹å³è¿”å›æ—§ç¼“å­˜ï¼ˆstale-while-revalidateï¼‰
4. åå°é‡æ–°æ¸²æŸ“
5. æ›´æ–° Full Route Cache å’Œ Data Cache
6. ä¸‹ä¸€ä¸ªç”¨æˆ·è·å¾—æ–°å†…å®¹

ç”¨æˆ·ä½“éªŒï¼šå§‹ç»ˆå¿«é€Ÿå“åº”ï¼Œæ— æ„ŸçŸ¥æ›´æ–°
```

---

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

#### 1. æ˜¾å¼å£°æ˜ç¼“å­˜ç­–ç•¥ (Next.js 15)

```jsx
// æ˜ç¡®ç¼“å­˜æ„å›¾
fetch('/api/posts', { cache: 'force-cache' })           // ç¼“å­˜
fetch('/api/user', { cache: 'no-store' })              // ä¸ç¼“å­˜
fetch('/api/data', { next: { revalidate: 3600 } })    // ISR
```

#### 2. ä½¿ç”¨æ ‡ç­¾ç®¡ç†ç¼“å­˜

```jsx
// ä¸ºç›¸å…³æ•°æ®åˆ†ç»„
fetch('/api/posts', {
  next: { tags: ['posts', 'blog'] }
})

fetch('/api/post/1', {
  next: { tags: ['posts', 'post-1'] }
})

// ç»Ÿä¸€é‡æ–°éªŒè¯
revalidateTag('posts') // æ¸…é™¤æ‰€æœ‰ posts ç›¸å…³ç¼“å­˜
```

#### 3. é€‰æ‹©åˆé€‚çš„ revalidate æ—¶é—´

```jsx
// é«˜é¢‘æ›´æ–°å†…å®¹ï¼ˆæ–°é—»ã€è‚¡ç¥¨ï¼‰
{ next: { revalidate: 60 } }        // 1 åˆ†é’Ÿ

// ä¸­é¢‘æ›´æ–°å†…å®¹ï¼ˆåšå®¢ã€äº§å“åˆ—è¡¨ï¼‰
{ next: { revalidate: 3600 } }      // 1 å°æ—¶

// ä½é¢‘æ›´æ–°å†…å®¹ï¼ˆæ–‡æ¡£ã€å…³äºé¡µé¢ï¼‰
{ next: { revalidate: 86400 } }     // 1 å¤©

// å‡ ä¹ä¸å˜å†…å®¹ï¼ˆæ³•å¾‹æ¡æ¬¾ï¼‰
{ cache: 'force-cache' }            // æ°¸ä¹…ç¼“å­˜
```

#### 4. ç»„åˆä½¿ç”¨ revalidatePath å’Œ revalidateTag

```jsx
'use server'
import { revalidatePath, revalidateTag } from 'next/cache'

export async function updatePost(id) {
  await db.post.update({ where: { id } })

  // æ¸…é™¤ç‰¹å®šè·¯å¾„
  revalidatePath(`/blog/${id}`)

  // æ¸…é™¤ç›¸å…³æ ‡ç­¾
  revalidateTag('posts')
  revalidateTag(`post-${id}`)
}
```

#### 5. é…ç½® Router Cache staleTime

```javascript
// next.config.js
module.exports = {
  experimental: {
    staleTimes: {
      dynamic: 30,     // åŠ¨æ€è·¯ç”±ç¼“å­˜ 30 ç§’
      static: 180,     // é™æ€è·¯ç”±ç¼“å­˜ 3 åˆ†é’Ÿ
    },
  },
}
```

### âŒ é¿å…çš„åšæ³•

#### 1. æ··åˆå†²çªçš„ç¼“å­˜é€‰é¡¹

```jsx
// âŒ é”™è¯¯ï¼šå†²çªé…ç½®ä¼šè¢«å¿½ç•¥
fetch('/api/data', {
  cache: 'no-store',
  next: { revalidate: 60 }
})

// âœ… æ­£ç¡®ï¼šé€‰æ‹©ä¸€ç§ç­–ç•¥
fetch('/api/data', {
  next: { revalidate: 60 }
})
```

#### 2. è¿‡åº¦ä¾èµ–é»˜è®¤è¡Œä¸º

```jsx
// âŒ ä¸æ¸…æ™°ï¼ˆNext.js 15 é»˜è®¤ä¸ç¼“å­˜ï¼‰
fetch('/api/data')

// âœ… æ˜¾å¼å£°æ˜
fetch('/api/data', { cache: 'no-store' })
```

#### 3. åœ¨ Static Export ä¸­ä½¿ç”¨ ISR

```jsx
// âŒ Static Export ä¸æ”¯æŒ ISR
export const dynamic = 'force-static'
fetch('/api/data', { next: { revalidate: 60 } })

// âœ… ä½¿ç”¨ Node.js è¿è¡Œæ—¶
// æˆ–ä½¿ç”¨å®Œå…¨é™æ€ï¼ˆæ—  revalidateï¼‰
```

#### 4. å¿½ç•¥ Request Memoization é™åˆ¶

```jsx
// âŒ ORM æŸ¥è¯¢ä¸ä¼šè‡ªåŠ¨å»é‡
async function getUser(id) {
  return db.user.findUnique({ where: { id } })
}

// âœ… ä½¿ç”¨ React cache
import { cache } from 'react'

const getUser = cache(async (id) => {
  return db.user.findUnique({ where: { id } })
})
```

---

## æ€»ç»“

### ğŸ¯ æ ¸å¿ƒè¦ç‚¹

1. **Next.js 15 é‡‡ç”¨ Opt-in ç¼“å­˜ç­–ç•¥**ï¼šé»˜è®¤ä¸ç¼“å­˜ï¼Œæ˜¾å¼å¯ç”¨
2. **å››å±‚ç¼“å­˜å„å¸å…¶èŒ**ï¼š
   - Request Memoization: å•æ¬¡è¯·æ±‚å»é‡
   - Data Cache: æŒä¹…åŒ–æ•°æ®ç¼“å­˜
   - Full Route Cache: è·¯ç”±æ¸²æŸ“ç»“æœç¼“å­˜
   - Router Cache: å®¢æˆ·ç«¯å¯¼èˆªç¼“å­˜
3. **ISR æ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®**ï¼šé™æ€ç”Ÿæˆ + åå°é‡æ–°éªŒè¯
4. **ç¼“å­˜å¤±æ•ˆéœ€è¦ååŒ**ï¼š`revalidatePath` å’Œ `revalidateTag` ç»Ÿä¸€ç®¡ç†

### ğŸ”— ç›¸å…³èµ„æº

- [Next.js å®˜æ–¹æ–‡æ¡£ - Caching](https://nextjs.org/docs/app/guides/caching)
- [Next.js 15 å‘å¸ƒåšå®¢](https://nextjs.org/blog/next-15)
- [ISR æŒ‡å—](https://nextjs.org/docs/app/guides/incremental-static-regeneration)

---

## Mini Next.js å®ç°å¯¹æ¯”

### å®ç°ç¨‹åº¦æ€»è§ˆ

æœ¬é¡¹ç›®å®ç°äº†ç®€åŒ–ç‰ˆç¼“å­˜ç³»ç»Ÿï¼Œä¸“æ³¨äº Full Route Cache (SSG/ISR)ï¼š

| ç¼“å­˜å±‚çº§ | Mini Next.js | Next.js 15 | å®ç°ç¨‹åº¦ |
|---------|--------------|-----------|---------|
| Request Memoization | âŒ æœªå®ç° | âœ… å®Œæ•´ | 0% |
| Data Cache | âŒ æœªå®ç° | âœ… å®Œæ•´ | 0% |
| Full Route Cache | âš ï¸ éƒ¨åˆ†å®ç° | âœ… å®Œæ•´ | 60% |
| Router Cache | âš ï¸ åŸºç¡€å®ç° | âœ… å®Œæ•´ | 40% |

### Full Route Cache å®ç°å¯¹æ¯”

#### âœ… å·²å®ç°åŠŸèƒ½

**æ„å»ºæ—¶é¢„æ¸²æŸ“** (`build/render-static.ts:40`)
```javascript
// æ”¶é›†é™æ€è·¯ç”±ï¼ˆæ’é™¤åŠ¨æ€è·¯ç”±å’Œ force-dynamicï¼‰
function collectStaticRoutes(node) {
  const isDynamicRoute = node.dynamic
  const isForceDynamic = node.page?.dynamic === 'force-dynamic'

  if (node.page && !isDynamicRoute && !isForceDynamic) {
    // å¯é¢„æ¸²æŸ“
  }
}
```

**ISR æ—¶é—´é‡æ–°éªŒè¯** (`server/index.ts:136`)
```javascript
// Stale-while-revalidate ç­–ç•¥
if (shouldRevalidate(url, prerenderInfo.revalidate)) {
  regenerateInBackground(url, options)  // åå°é‡æ–°ç”Ÿæˆ
}
return fs.readFileSync(filePath)  // ç«‹å³è¿”å›æ—§ç¼“å­˜
```

**é˜²é‡å¤ç”Ÿæˆé”** (`server/regenerate.ts:103`)
```javascript
const regenerationLocks = new Map()

if (regenerationLocks.has(routePath)) {
  return regenerationLocks.get(routePath)  // å¤ç”¨è¿›è¡Œä¸­çš„ä»»åŠ¡
}
```

**åŸå­æ€§æ–‡ä»¶å†™å…¥** (`server/regenerate.ts:75`)
```javascript
// é¿å…è¯»åˆ°ä¸å®Œæ•´æ–‡ä»¶
fs.writeFileSync(htmlTempPath, html)
fs.renameSync(htmlTempPath, htmlPath)
```

#### âŒ æœªå®ç°åŠŸèƒ½

- æŒ‰éœ€é‡æ–°éªŒè¯ (`revalidatePath`, `revalidateTag`)
- åŠ¨æ€è·¯ç”± SSG (`generateStaticParams`)
- Request Memoizationï¼ˆè¯·æ±‚å»é‡ï¼‰
- ç‹¬ç«‹çš„ Data Cache å±‚
- Router Cacheï¼ˆRSC Payload ç¼“å­˜ã€é¢„å–ï¼‰

### æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | Mini Next.js | Next.js 15 | å·®è· |
|-----|-------------|-----------|-----|
| é¦–æ¬¡é™æ€é¡µé¢ | ~50ms | ~50ms | âœ… ç›¸åŒ |
| ISR é‡æ–°éªŒè¯ | ~50ms | ~50ms | âœ… ç›¸åŒ |
| å®¢æˆ·ç«¯å¯¼èˆª | 200-500ms | 10-50ms | ğŸ”´ æ…¢ 5-10 å€ |
| å‰è¿›/åé€€ | 200-500ms | ~10ms | ğŸ”´ æ…¢ 20-50 å€ |

**æ€§èƒ½å·®è·åŸå› **ï¼š
- ç¼ºå°‘ Router Cacheï¼Œæ¯æ¬¡å¯¼èˆªéƒ½éœ€ç½‘ç»œè¯·æ±‚
- æ— é¢„å–æœºåˆ¶ï¼Œæ— æ³•åå°åŠ è½½è·¯ç”±
- æ— æ»šåŠ¨ä½ç½®æ¢å¤

### å­¦ä¹ ä»·å€¼

#### âœ… é€‚åˆå­¦ä¹ çš„å†…å®¹

1. **ISR æ ¸å¿ƒåŸç†**ï¼ˆ`server/index.ts:136-158`ï¼‰
   - Stale-while-revalidate ç­–ç•¥
   - åå°é‡æ–°ç”Ÿæˆæœºåˆ¶
   - å…ƒæ•°æ®ç®¡ç†

2. **é™æ€è·¯ç”±æ£€æµ‹**ï¼ˆ`build/render-static.ts:148-171`ï¼‰
   - åˆ¤æ–­è·¯ç”±æ˜¯å¦å¯é¢„æ¸²æŸ“
   - åŠ¨æ€è·¯ç”±æ®µæ£€æµ‹

3. **é”æœºåˆ¶è®¾è®¡**ï¼ˆ`server/regenerate.ts:103-130`ï¼‰
   - é˜²æ­¢é‡å¤ç”Ÿæˆ
   - å¹¶å‘åœºæ™¯èµ„æºç®¡ç†

#### âš ï¸ éœ€å‚è€ƒ Next.js æ–‡æ¡£

- Request Memoization å’Œ `React.cache()`
- Data Cache ç‹¬ç«‹ç®¡ç†
- Router Cache é…ç½®å’Œä¼˜åŒ–

---

**æ›´æ–°æ—¥æœŸ**: 2025-01-02
**é€‚ç”¨ç‰ˆæœ¬**: Next.js 15.x
**Mini Next.js**: v1.0
